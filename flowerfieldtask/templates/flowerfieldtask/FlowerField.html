{# This file defines the oTree page sequence, page logic, and custom export for the flower field experiment.
It controls what each page does, when it is shown, and how participant data is processed and exported. #}


{# Django static files loader #}
{% load static %}

{# Main content block for oTree/Django template #}
{% block content %}
    {# Inline CSS for game controls and layout #}
    <style>
        .game-controls .submit-button,
        .game-controls .reset-button {
            font-size: 0.95em;
            padding: 4px 16px;
            min-width: 80px;
            height: 32px;
        }
        #flower-field-wrapper.exploration-flowers {
            text-align: center;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>


{# Include shared scripts for oTree (Django include) #}
{% include "_templates/scripts.html" %}


{# Main stylesheet for flower task #}
<link rel="stylesheet" href="{% static 'css/flowers.css' %}?v=11">
<title>Flower Field Task</title>

{# Main container for the flower field task #}
<div id="main-container">
    {# Top row: shows phase and round info #}
    <div class="row m-0 p-0" id="toprow" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
        <div class="col-12 p-1 mt-1" style="width: 100%; max-width: 700px; text-align: center; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background: white;">
            <h4 style="margin-bottom:0.5em;">
                {% if phase == 'Training phase' %}First phase
                {% elif phase == 'Exploration phase' %}Second phase
                {% else %}{{ phase }}
                {% endif %}
            </h4>
            <h5>Round {{ phase_round }} / {{ phase_total }}</h5>
            <div id="top-earnings" style="font-size:1.1em; margin-top:0.5em;">
                Total earnings: £<span id="totalEarningsResult">{{ cumulative_earnings }}</span>
            </div>
        </div>
    </div>
    {# Show submitted configuration panel if treatment matches #}
    {% if treatment == 'submitted Correct' or treatment == 'submitted M&M' %}
    <div id="submitted-panel" style="padding: 8px 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 160px; min-height: 60px; max-width: 220px; margin: 16px auto 0 auto; text-align: center;">
        <h5 style="margin-bottom: 10px; color: #333;">Previously produced configuration</h5>
        {% if submitted_photo %}
            <img src="{% static submitted_photo %}" alt="submitted configuration" style="max-width: 120px; max-height: 120px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 8px;">
        {% else %}
            <span style="color: #888; font-size: 0.95em;">No configuration submitted yet.</span>
        {% endif %}
    </div>
    {% endif %}

    {# Instructions row: changes text depending on phase #}
    <div class="row m-0 p-0" id="instructions-row">
        <div class="col-12 p-2 text-center" style="font-size: 0.9rem; color: #333;">
            {% if phase == 'Test 1' or phase == 'Test 2' %}
                {# Test phases: special instructions and warning #}
                <span style="color: #a80000; font-weight: bold;">Select the configuration that fits best with your understanding of what causes flowers to grow.<br>
                The score for each flower will be doubled. This set may be shown to following participants.</span> <br><br>
                Click the <b>“submit"</b> button when you are ready.
            {% else %}
                {# Training/Exploration: normal instructions #}
                Drag <b> one or two nutrients </b> under each flower to select your configuration.<br>
                Click the <b> “Submit" </b> button when you are ready to grow the flowers.
            {% endif %}
        </div>
    </div>

    {# Main game and results area #}
    <div class="row m-0 p-0" style="width: 100%;">
        <div class="col-12" id="currentRound" style="width: 100%; display: flex; justify-content: center; align-items: flex-start;">
            {# Flower Field Game #}
            <div class="flower-game-container" style="width: 100%;">
                {# Main panel for the flower field game #}
                <div id="flower-field-panel" class="white-panel">
                    {# Panel border changes color in Test 1 phase #}
                    {% if phase == 'Test 1' or phase == 'Test 2' %}
                    {# Highlight panel border in test phases #}
                    <style>
                        #flower-field-panel {
                            border: 3px solid #a80000;
                            border-radius: 10px;
                        }
                    </style>
                    {% endif %}
                    <div class="game-main">
                        {# Status message area for warnings/errors #}
                        <div id="status-message"></div>
                        {# Show environmental parameters only after feedback in Training/Exploration #}
                        {% if phase == 'Training phase' or phase == 'Exploration phase' %}
                        <div id="env-params" style="font-size:0.90em; margin-bottom:0.7em; color:black; display:none; text-align:center;">
                            During this season, the average daily temperature and rainfall were :
                            <span style="font-weight:bold">{{ temperature }} °C</span> and <span style="font-weight:bold">{{ rainfall }} mm</span>.
                        </div>
                        {% endif %}
                        <div id="flower-field-wrapper" class="{{ phase_class }}">
                            {# JS will fill flower-field with correct layout #}
                            <div id="flower-field" class="flower-slots-row" style="display: flex; justify-content: center; align-items: flex-end; width: 100%;"></div>
                        </div>
                        {# Game control buttons: Reset, Submit, Next Round #}
                        <div class="game-controls">
                            <button class="reset-button" id="resetButton" {% if round_submitted %}disabled style="display:none;"{% endif %}>Reset</button>
                            <button class="submit-button" id="submitButton" {% if round_submitted %}disabled style="display:none;"{% endif %}>Submit</button>
                            <button class="submit-button" id="nextRoundButton" {% if round_submitted %}style=""{% else %}style="display:none;"{% endif %}>Go to the next round</button>
                        </div>
                        {# Feedback panels are injected dynamically after submitting Test 2. Test 1 feedback is NOT shown immediately after Test 1. #}
                        <script>
                        // Show environmental parameters after feedback (after submit)
                        document.addEventListener('DOMContentLoaded', function() {
                            var submitBtn = document.getElementById('submitButton');
                            var envParams = document.getElementById('env-params');
                            var nextRoundBtn = document.getElementById('nextRoundButton');
                            var phase = '{{ phase }}';
                            var roundSubmitted = {{ round_submitted|json }};
                            if (roundSubmitted) {
                                // Show the feedback directly
                                if (envParams) envParams.style.display = 'block';
                                if (submitBtn) submitBtn.disabled = true;
                                if (submitBtn) submitBtn.style.display = 'none';
                                if (nextRoundBtn) nextRoundBtn.style.display = '';
                                if (resetButton) resetButton.disabled = true;
                                if (resetButton) resetButton.style.display = 'none';
                            } else if (submitBtn && envParams && (phase === 'Training phase' || phase === 'Exploration phase')) {
                                submitBtn.addEventListener('click', function() {
                                    setTimeout(function() {
                                        if (window.flowerGame && window.flowerGame.isComplete()) {
                                            envParams.style.display = 'block';
                                        }
                                    }, 100);
                                });
                            }
                        });
                        </script>
                    </div>
                </div>
                <div class="side-panel-stack">
                    <div id="nutrient-panel" style="height:48px; min-height:32px; max-height:60px;"></div>
                    {# Show transmission panel for 'Transmission correct' treatment #}
                    {% if treatment == 'Transmission correct' %}
                    <div id="submitted-panel" class="submitted-visible" style="padding: 16px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.13); min-width: 150px; min-height: 80px; max-width: 270px; margin: 10px auto 0 auto; text-align: center;">
                        <h6 style="margin-bottom: 6px; color: #333; font-size: 1em;">Produced by a previous participant :</h6>
                        <img src="{% static 'img/TransCorr.png' %}" alt="submitted configuration" style="max-width: 225px; max-height: 250px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.13); margin-bottom: 5px;">
                    </div>
                    {# Show transmission panel for 'Transmission M&M' treatment #}
                    {% elif treatment == 'Transmission M&M' %}
                    <div id="submitted-panel" class="submitted-visible" style="padding: 16px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.13); min-width: 150px; min-height: 80px; max-width: 270px; margin: 10px auto 0 auto; text-align: center;">
                        <h6 style="margin-bottom: 6px; color: #333; font-size: 1em;">Produced by a previous participant :</h6>
                        <img src="{% static 'img/TransMM.png' %}" alt="submitted configuration" style="max-width: 225px; max-height: 250px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.13); margin-bottom: 5px;">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{# Show previous combinations only in first and second phases #}
{% if phase == 'Training phase' or phase == 'Exploration phase' %}
<div id="previous-combinations" style="width:100%; padding:8px 0 8px 0; text-align:center; margin:24px auto 0 auto; max-height:120px; overflow-y:auto;">
    {% if previous_combinations|length > 0 %}
    <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
        {# Loop through previous combinations and display them #}
        {% for combo in previous_combinations %}
                <div class="prev-combo{% if combo.zipped|length == 2 %} two-flowers{% endif %}" style="border:1px solid #ccc; border-radius:8px; padding:6px 10px 10px 10px; background:#fafafa; min-width:160px; max-width:220px; font-size:0.85em; display:flex; flex-direction:column; align-items:center;">
            <div style="font-weight:bold; margin-bottom:2px; font-size:0.95em;">Round {{ combo.round }}</div>
            <div style="display:flex; justify-content:center; align-items:flex-end; width:100%; gap:40px;">
                {# For each flower in the combination, show image, nutrients, and score #}
                {% for flower, nutrient, score, flower_img, growth, flower_size in combo.zipped %}
                <div style="display:flex; flex-direction:column; align-items:center; margin:0 1px;">
                    {% if flower_img %}
                        {% if flower_size %}
                            <img src="{% static flower_img %}" width="{{ flower_size }}" height="{{ flower_size }}" style="margin-bottom:2px;" alt="{{ flower }}">
                        {% else %}
                            <img src="{% static flower_img %}" width="32" height="32" style="margin-bottom:2px;" alt="{{ flower }}">
                        {% endif %}
                    {% endif %}
                    <div style="display:flex; gap:1px; margin-bottom:1px; margin-top:2px;">
                        {% for nutrient_img in nutrient %}
                        {% if nutrient_img %}<img src="{% static nutrient_img %}" style="width:16px; height:16px;" alt="nutrient">{% endif %}
                        {% endfor %}
                    </div>
                    <span style="font-size:0.85em; color:#444; font-weight:bold; margin-top:0px;">{{ score }}p</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
    <style>
    .prev-combo.two-flowers .prev-combo-flowers-row,
    .prev-combo.two-flowers .prev-combo-scores-row {
        display: flex !important;
        justify-content: center !important;
        gap: 48px !important;
    }
    .prev-combo-flowers-row,
    .prev-combo-scores-row {
        display: flex;
        justify-content: space-between;
        width: 100%;
        gap: 0;
        margin-top: 2px;
    }
    </style>
{% endif %}

    <style>
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #flower-field-wrapper.training-phase-flowers {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.training-phase-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.training-phase-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }

        #flower-field-wrapper.test-1-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.test-1-flowers #flower-field {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        #flower-field-wrapper.test-1-flowers .flower-container {
            width: 30%;
            margin: 10px 2%;
        }
        #flower-field-wrapper.test-1-flowers #flower-field .flower-container:nth-child(n+4) {
            margin-top: 40px;
        }
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>

    {# JS variables and game initialization #}
    <script>
        window.js_vars = window.js_vars || {};
        window.js_vars.treatment = "{{ session.config.display_name }}";
        window.js_vars.current_round = "{{ player.round_number }}";
        window.js_vars.phase = "{{ phase }}";
        window.js_vars.flower_colors = JSON.parse('{{ flower_colors|safe }}');
        window.js_vars.round_submitted = {{ round_submitted|json }};
        window.js_vars.flower_scores = {% if flower_scores %}{{ flower_scores|json }}{% else %}null{% endif %};
        window.js_vars.flower_earnings = {% if flower_earnings %}{{ flower_earnings|json }}{% else %}null{% endif %};
        // Pass nutrients for this round if submitted
        {% if round_submitted and phase in ['Training phase', 'Exploration phase'] %}
        {% for entry in participant.vars.nutrient_flower_history %}
            {% if entry.phase == phase and entry.round == phase_round %}
                window.js_vars.flower_nutrients = {{ entry.nutrients|safe }};
            {% endif %}
        {% endfor %}
        {% endif %}

        console.log('Flowers template loaded, initializing...');
        // Initialize the game
        function initGame() {
            console.log('Attempting to initialize FlowerGame');
            console.log('window.FlowerGame exists:', typeof window.FlowerGame);
            if (window.flowerGame) {
                console.log('FlowerGame already created');
                return;
            }
            if (typeof FlowerGame !== 'undefined') {
                console.log('Creating new FlowerGame instance');
                window.flowerGame = new FlowerGame();
                // Pass flower colors for this round to the game instance
                if (window.js_vars.flower_colors) {
                    window.flowerGame.roundFlowerTypes = [window.js_vars.flower_colors];
                }
                console.log('FlowerGame created successfully');
                // Now initialize the game (populate the DOM)
                console.log('Initializing game UI...');
                window.flowerGame.init();
                // If round_submitted, show feedback immediately (for Training/Exploration)
                if (window.js_vars.round_submitted && (window.js_vars.phase === 'Training phase' || window.js_vars.phase === 'Exploration phase')) {
                    if (window.js_vars.flower_scores && window.flowerGame.animateFlowerSizes) {
                        window.flowerGame.animateFlowerSizes(window.js_vars.flower_scores);
                    }
                    if (window.js_vars.flower_scores && window.js_vars.flower_earnings && window.flowerGame.showAllScores) {
                        let scaledScores = window.js_vars.flower_scores.map(x => Math.round(x * 400));
                        window.flowerGame.showAllScores(scaledScores, window.js_vars.flower_earnings);
                    }
                }
                console.log('Game UI initialized');
            } else {
                console.error('FlowerGame class not found!');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
        // Unified popup and overlay for Test 1 and Test 2 phases
        if (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2') {
            const overlay = document.createElement('div');
            overlay.id = 'test1-blocking-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(255,255,255,0.7)';
            overlay.style.zIndex = '9998';
            const style = document.createElement('style');
            style.innerHTML = '.bootbox.modal { z-index: 10000 !important; } .modal-backdrop { z-index: 9999 !important; }';
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            if (typeof bootbox !== 'undefined') {
                bootbox.dialog({
                    message: `<div style='font-size:1.15em; text-align:center;'>
                        <div style='margin-bottom:1em;'>Please note that the next round is a test. <b>The monetary reward for each flower is doubled.</b> Your score and feedback will be revealed and added to your total earnings at the end of the experiment.</div>
                    </div>`,
                    buttons: [
                        {
                            label: 'I understand',
                            className: 'btn-primary',
                            callback: function() {
                                // Remove overlay by ID
                                var overlays = document.querySelectorAll('#test1-blocking-overlay');
                                overlays.forEach(function(overlayElem) {
                                    if (overlayElem && overlayElem.parentNode) {
                                        overlayElem.parentNode.removeChild(overlayElem);
                                    }
                                });
                                // Remove any overlays with a likely overlay class
                                var overlayClassElems = document.querySelectorAll('.blocking-overlay, .otree-blocking-overlay');
                                overlayClassElems.forEach(function(elem) {
                                    if (elem && elem.parentNode) {
                                        elem.parentNode.removeChild(elem);
                                    }
                                });
                                // Restore scrolling
                                document.body.style.overflow = '';
                                document.documentElement.style.overflow = '';
                                // Forcefully remove Bootbox modal from DOM
                                var modals = document.querySelectorAll('.bootbox');
                                modals.forEach(function(modal) {
                                    if (modal && modal.parentNode) {
                                        modal.parentNode.removeChild(modal);
                                    }
                                });
                                // Also remove any modal-backdrop
                                var backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(function(backdrop) {
                                    if (backdrop && backdrop.parentNode) {
                                        backdrop.parentNode.removeChild(backdrop);
                                    }
                                });
                                return true;
                            }
                        }
                    ],
                    closeButton: false
                });
            } else {
                alert('Please note that the next round is a test. <b>The monetary reward for each flower is doubled. Your score and feedback will be revealed and added to your total earnings at the end of the experiment.</b> The configuration you produce may be seen by following participant(s).');
                if (overlay && overlay.parentNode === document.body) {
                    document.body.removeChild(overlay);
                }
            }
        }
        initGame();
        // Reset button should only reset the field
        const resetButton = document.getElementById('resetButton');
        if (resetButton) {
            resetButton.addEventListener('click', function(event) {
                event.preventDefault();
                window.flowerGame.resetFlowerField();
                document.getElementById('status-message').innerHTML = '';
            });
        }
        // Submit button should not advance round if not all flowers have at least one nutrient
        const submitButton = document.getElementById('submitButton');
        if (submitButton) {
            submitButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (!window.flowerGame.isComplete()) {
                    document.getElementById('status-message').innerHTML = '<div class="status-message warning">Please feed all flowers with at least 1 nutrient each!</div>';
                    setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                    return;
                }
                const resetButton = document.getElementById('resetButton');
                const nextRoundButton = document.getElementById('nextRoundButton');
                if (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2') {
                    // Hide all control buttons during submit
                    submitButton.style.display = 'none';
                    if (resetButton) resetButton.style.display = 'none';
                    if (nextRoundButton) nextRoundButton.style.display = 'none';
                    // Show confirmation popup only for Test 1 and Test 2
                    let popupMessage = "Are you sure you’ve put the desired nutrients ?";
                    let yesLabel = 'Yes submit';
                    if (typeof bootbox !== 'undefined') {
                        bootbox.dialog({
                            message: `<div style='font-size:1.1em; text-align:center;'>${popupMessage}</div>`,
                            buttons: [
                                {
                                    label: yesLabel,
                                    className: 'btn-primary',
                                    callback: function() {
                                        submitButton.disabled = true;
                                        document.getElementById('status-message').innerHTML = '';
                                        const flowerChoices = window.flowerGame.getFlowerChoices();
                                        liveSend({
                                            type: 'flowerSubmit',
                                            data: flowerChoices
                                        });
                                        return true;
                                    }
                                },
                                {
                                    label: 'No, continue editing',
                                    className: 'btn-secondary',
                                    callback: function() {
                                        if (resetButton) {
                                            resetButton.style.display = '';
                                        }
                                        submitButton.style.display = '';
                                        if (nextRoundButton) nextRoundButton.style.display = 'none';
                                        return true;
                                    }
                                }
                            ]
                        });
                    }
                } else {
                    // Direct submit for all other phases
                    if (resetButton) {
                        resetButton.style.display = 'none';
                    }
                    submitButton.style.display = 'none';
                    document.getElementById('status-message').innerHTML = '';
                    const flowerChoices = window.flowerGame.getFlowerChoices();
                    liveSend({
                        type: 'flowerSubmit',
                        data: flowerChoices
                    });
                }
            });
        }
        // Next round button handler
        const nextRoundButton = document.getElementById('nextRoundButton');
        if (nextRoundButton) {
            nextRoundButton.addEventListener('click', function(event) {
                event.preventDefault();
                let form = document.getElementById('nextRoundForm');
                if (!form) {
                    form = document.createElement('form');
                    form.id = 'nextRoundForm';
                    form.method = 'post';
                    form.style.display = 'none';
                    document.body.appendChild(form);
                }
                form.submit();
            });
        }
        // Listen for liveRecv to handle server response
        window.liveRecv = function(data) {
            // Accept both direct and wrapped responses
            let responseData = null;
            if (data && data.cumulative_earnings !== undefined) {
                responseData = data;
            } else {
                for (let key in data) {
                    if (data[key] && data[key].cumulative_earnings !== undefined) {
                        responseData = data[key];
                        break;
                    }
                }
            }
            if (responseData && responseData.cumulative_earnings !== undefined) {
                // Special handling for Test 1 and Test 2 only
                if (window.js_vars && window.js_vars.phase === 'Test 1') {
                    // Immediately submit form to go to next phase
                    let form = document.getElementById('nextRoundForm');
                    if (!form) {
                        form = document.createElement('form');
                        form.id = 'nextRoundForm';
                        form.method = 'post';
                        form.style.display = 'none';
                        document.body.appendChild(form);
                    }
                    form.submit();
                    return;
                }
                if (window.js_vars && window.js_vars.phase === 'Test 2' && responseData.test1_data && responseData.test2_data) {
                    // Store test results for later use if needed
                    sessionStorage.setItem('test1_data', JSON.stringify(responseData.test1_data));
                    sessionStorage.setItem('test2_data', JSON.stringify(responseData.test2_data));
                    // Submit form to advance to next oTree page (TestResults)
                    let form = document.getElementById('nextRoundForm');
                    if (!form) {
                        form = document.createElement('form');
                        form.id = 'nextRoundForm';
                        form.method = 'post';
                        form.style.display = 'none';
                        document.body.appendChild(form);
                    }
                    form.submit();
                    return;
                }
                // For all other phases (Training, Exploration), show feedback and allow normal progression
                if (typeof disableNutrientPanelAndSlots === 'function') {
                    disableNutrientPanelAndSlots();
                }
                // Use backend-provided growths_for_display if present, else fallback to flower_scores
                if (window.flowerGame && typeof window.flowerGame.animateFlowerSizes === 'function') {
                    if (responseData.growths_for_display) {
                        window.flowerGame.animateFlowerSizes(responseData.growths_for_display);
                    } else {
                        window.flowerGame.animateFlowerSizes(responseData.flower_scores);
                    }
                }
                if (window.flowerGame && typeof window.flowerGame.showAllScores === 'function') {
                    let scaledScores = responseData.flower_scores.map(x => Math.round(x * 400));
                    window.flowerGame.showAllScores(scaledScores, responseData.flower_earnings);
                }
                if (responseData.cumulative_earnings !== undefined) {
                    const totalEarningsElem = document.getElementById('totalEarningsResult');
                    if (totalEarningsElem) {
                        totalEarningsElem.textContent = responseData.cumulative_earnings;
                    }
                }
                // Show next round button after feedback animation
                if (window.js_vars.phase === 'Training phase' || window.js_vars.phase === 'Exploration phase') {
                    const nextRoundButton = document.getElementById('nextRoundButton');
                    if (nextRoundButton) {
                        nextRoundButton.style.display = '';
                    }
                }
            }
        };
        // Format total earnings on page load
        var totalEarningsElem = document.getElementById('totalEarningsResult');
        if (totalEarningsElem) {
            var val = parseFloat(totalEarningsElem.textContent);
            if (!isNaN(val)) {
                totalEarningsElem.textContent = val.toFixed(2);
            }
        }
    });

</script>
{# Main JS for flower game #}
<script src="{% static 'js/flowers.js' %}?v=7"></script>
{% endblock %}
