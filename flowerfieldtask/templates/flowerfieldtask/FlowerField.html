{% load static %}
{# Django static files loader #}
{% load static %}

{% block content %}
    <style>
        #flower-field-wrapper.exploration-flowers {
            text-align: center;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>

{# Include shared scripts for oTree #}
{% include "_templates/scripts.html" %}

{# Main stylesheet for flower task #}
<link rel="stylesheet" href="{% static 'css/flowers.css' %}?v=11">
<title>Flower Field Task</title>

<div id="main-container">
    {# Top row: phase and round info #}
    <div class="row m-0 p-0" id="toprow">
        <div class="col-12 p-1 border mt-1">
            <h4 class="text-center" style="margin-bottom:0.5em;">{{ phase }}</h4>
            <h5 class="text-center">Round {{ phase_round }} / {{ phase_total }}</h5>
        </div>
    </div>

    {# Instructions row: changes text depending on phase #}
    <div class="row m-0 p-0" id="instructions-row">
        <div class="col-12 p-2 text-center" style="font-size: 0.9rem; color: #333;">
            {% if phase == 'Test 1' or phase == 'Test 2' %}
                <span style="color: #a80000; font-weight: bold;">Select the configuration that fits best with your understanding of what causes flowers to grow.<br>
                This set will be transmitted to following participants.</span> <br><br>
                Click the <b>“Transmit"</b> button when you are ready.
            {% else %}
                Drag <b> one or two nutrients </b> under each flower to select your configuration.<br>
                Click the <b> “Submit Round" </b> button when you are ready to grow the flowers.
            {% endif %}
        </div>
    </div>

    {# Main game and results area #}
    <div class="row m-0 p-0" style="width: 100%; min-height: 700px;">
        <div class="col-12" id="currentRound" style="min-height: 700px; width: 100%; display: flex;">
            <!-- Flower Field Game -->
            <div class="flower-game-container" style="width: 100%;">
                <div id="flower-field-panel" class="white-panel">
                    {# Panel border changes color in Test 1 phase #}
                    {% if phase == 'Test 1' or phase == 'Test 2' %}
                    <style>
                        #flower-field-panel {
                            border: 3px solid #a80000;
                            border-radius: 10px;
                        }
                    </style>
                    {% endif %}
                    <div class="game-main">
                        <div id="status-message"></div>
                        <div id="flower-field-wrapper" class="{{ phase_class }}">
                            <!-- JS will fill flower-field with correct layout -->
                            <div id="flower-field"></div>
                        </div>
                        <div class="game-controls">
                            <button class="submit-button" id="submitButton">{% if phase == 'Test 1' %}Transmit{% else %}Submit Round{% endif %}</button>
                            <button class="reset-button" id="resetButton">Reset</button>
                        </div>
                    </div>
                </div>
                <div class="side-panel-stack">
                    <div id="nutrient-panel"></div>
                    <div id="results-section" class="text-center mt-3 mb-1">
                        <h4 id="result">Result in this round:</h4>
                        Average Growth: <span id="speedResult"></span> %<br>
                        Earnings: £<span id="pointsResult"></span><br>
                        Total earnings: £<span id="totalEarningsResult">{{ player.cumulative_earnings }}</span><br>
                        <br>
                        <!-- Hidden form for round advancement -->
                        <form id="nextRoundForm" method="post" style="display:none;"></form>
                    </div>
                </div>
            </div>
            <!-- Removed duplicate results section -->
        </div>
    </div>
</div>

    <style>
        /* Center the card and its contents for Exploration phase */
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #flower-field-wrapper.training-phase-flowers {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.training-phase-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.training-phase-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }

        #flower-field-wrapper.test-1-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.test-1-flowers #flower-field {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        #flower-field-wrapper.test-1-flowers .flower-container {
            width: 30%;
            margin: 10px 2%;
        }
        #flower-field-wrapper.test-1-flowers #flower-field .flower-container:nth-child(n+4) {
            margin-top: 40px;
        }
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>
    </style>
    <script>
        window.js_vars = window.js_vars || {};
        window.js_vars.current_round = "{{ player.round_number }}";
        window.js_vars.phase = "{{ phase }}";
        window.js_vars.flower_colors = JSON.parse('{{ flower_colors|safe }}');

        console.log('Flowers template loaded, initializing...');
        // Initialize the game
        function initGame() {
            console.log('Attempting to initialize FlowerGame');
            console.log('window.FlowerGame exists:', typeof window.FlowerGame);
            if (window.flowerGame) {
                console.log('FlowerGame already created');
                return;
            }
            if (typeof FlowerGame !== 'undefined') {
                console.log('Creating new FlowerGame instance');
                window.flowerGame = new FlowerGame();
                // Pass flower colors for this round to the game instance
                if (window.js_vars.flower_colors) {
                    window.flowerGame.roundFlowerTypes = [window.js_vars.flower_colors];
                }
                console.log('FlowerGame created successfully');
                // Now initialize the game (populate the DOM)
                console.log('Initializing game UI...');
                window.flowerGame.init();
                console.log('Game UI initialized');
            } else {
                console.error('FlowerGame class not found!');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
        // Unified popup and overlay for Test 1 and Test 2 phases
        if (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2') {
            const overlay = document.createElement('div');
            overlay.id = 'test1-blocking-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(255,255,255,0.7)';
            overlay.style.zIndex = '9998';
            const style = document.createElement('style');
            style.innerHTML = '.bootbox.modal { z-index: 10000 !important; } .modal-backdrop { z-index: 9999 !important; }';
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            if (typeof bootbox !== 'undefined') {
                bootbox.dialog({
                    message: `<div style='font-size:1.15em; text-align:center;'>
                        <img src='${window.static ? window.static('img/Chain.png') : '/static/img/Chain.png'}' style='height:60px; margin-bottom:1em;'>
                        <div style='margin-bottom:1em;'>Please note that in the next round, the configuration you will choose will be seen by the next participant(s) in the chain.</div>
                    </div>`,
                    buttons: [
                        {
                            label: 'I understand',
                            className: 'btn-primary',
                            callback: function() {
                                // Remove overlay by ID
                                var overlays = document.querySelectorAll('#test1-blocking-overlay');
                                overlays.forEach(function(overlayElem) {
                                    if (overlayElem && overlayElem.parentNode) {
                                        overlayElem.parentNode.removeChild(overlayElem);
                                    }
                                });
                                // Remove any overlays with a likely overlay class
                                var overlayClassElems = document.querySelectorAll('.blocking-overlay, .otree-blocking-overlay');
                                overlayClassElems.forEach(function(elem) {
                                    if (elem && elem.parentNode) {
                                        elem.parentNode.removeChild(elem);
                                    }
                                });
                                // Restore scrolling
                                document.body.style.overflow = '';
                                document.documentElement.style.overflow = '';
                                // Forcefully remove Bootbox modal from DOM
                                var modals = document.querySelectorAll('.bootbox');
                                modals.forEach(function(modal) {
                                    if (modal && modal.parentNode) {
                                        modal.parentNode.removeChild(modal);
                                    }
                                });
                                // Also remove any modal-backdrop
                                var backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(function(backdrop) {
                                    if (backdrop && backdrop.parentNode) {
                                        backdrop.parentNode.removeChild(backdrop);
                                    }
                                });
                                return true;
                            }
                        }
                    ],
                    closeButton: false
                });
            } else {
                alert('Please note that in the next round, the configuration you will choose will be seen by the next participant(s) in the chain.');
                if (overlay && overlay.parentNode === document.body) {
                    document.body.removeChild(overlay);
                }
            }
        }
        initGame();
        // Fix: Reset button should only reset the field, not advance round
        const resetButton = document.getElementById('resetButton');
        if (resetButton) {
            resetButton.addEventListener('click', function(event) {
                event.preventDefault();
                window.flowerGame.resetFlowerField();
                document.getElementById('status-message').innerHTML = '';
            });
        }
        // Fix: Submit button should not advance round if not all flowers have at least one nutrient
        const submitButton = document.getElementById('submitButton');
        if (submitButton) {
            submitButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (!window.flowerGame.isComplete()) {
                    document.getElementById('status-message').innerHTML = '<div class="status-message warning">Please feed all flowers with at least 1 nutrient each!</div>';
                    setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                    return;
                }
                // If complete, proceed with liveSend
                const flowerChoices = window.flowerGame.getFlowerChoices();
                submitButton.disabled = true;
                document.getElementById('status-message').innerHTML = '';
                liveSend({
                    type: 'flowerSubmit',
                    data: flowerChoices
                });
            });
        }
        // Listen for liveRecv to handle server response
        window.liveRecv = function(data) {
            // Accept both direct and wrapped responses
            let responseData = null;
            if (data && data.total_growth !== undefined) {
                responseData = data;
            } else {
                for (let key in data) {
                    if (data[key] && data[key].total_growth !== undefined) {
                        responseData = data[key];
                        break;
                    }
                }
            }
            if (responseData && responseData.total_growth !== undefined) {
                // Animate flower sizes and show results
                if (window.flowerGame && typeof window.flowerGame.animateFlowerSizes === 'function') {
                    window.flowerGame.animateFlowerSizes(responseData.flower_scores);
                }
                // Show scores under each flower after submit
                if (window.flowerGame && typeof window.flowerGame.showAllScores === 'function') {
                    window.flowerGame.showAllScores();
                }
                setTimeout(() => {
                    document.getElementById('results-section').style.display = 'block';
                    document.getElementById('speedResult').textContent = (responseData.total_growth * 100).toFixed(1);
                    document.getElementById('pointsResult').textContent = responseData.total_points.toFixed(2);
                    if (responseData.cumulative_earnings !== undefined) {
                        document.getElementById('totalEarningsResult').textContent = parseFloat(responseData.cumulative_earnings).toFixed(2);
                    }
                    submitButton.style.display = 'none';
                    resetButton.style.display = 'none';
                    document.getElementById('status-message').innerHTML = '';
                    // Add Continue button under earnings section
                    let continueBtn = document.getElementById('continueAfterResults');
                    if (!continueBtn) {
                        continueBtn = document.createElement('button');
                        continueBtn.id = 'continueAfterResults';
                        continueBtn.className = 'btn btn-primary mt-3';
                        continueBtn.textContent = (window.js_vars && (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2')) ? 'Transmit' : 'Continue to Next Round';
                        continueBtn.onclick = function() {
                            document.getElementById('nextRoundForm').submit();
                        };
                        // Place button under earnings section
                        const earningsSection = document.querySelector('.text-center.mt-3.mb-1');
                        if (earningsSection) {
                            earningsSection.appendChild(continueBtn);
                        } else {
                            document.getElementById('results-section').appendChild(continueBtn);
                        }
                    }
                }, 700);
            }
        };
        // Format total earnings on page load
        var totalEarningsElem = document.getElementById('totalEarningsResult');
        if (totalEarningsElem) {
            var val = parseFloat(totalEarningsElem.textContent);
            if (!isNaN(val)) {
                totalEarningsElem.textContent = val.toFixed(2);
            }
        }
        // (Removed duplicate Test 1 popup logic; now unified above)

    });
</script>
<script src="{% static 'flowers.js' %}?v=7"></script>
{% endblock %}
