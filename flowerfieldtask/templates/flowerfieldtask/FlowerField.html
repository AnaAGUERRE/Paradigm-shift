{% load static %}
{# Django static files loader #}
{% load static %}

{% block content %}
    <style>
                /* Make game control buttons smaller */
                .game-controls .submit-button,
                .game-controls .reset-button {
                    font-size: 0.95em;
                    padding: 4px 16px;
                    min-width: 80px;
                    height: 32px;
                }
        #flower-field-wrapper.exploration-flowers {
            text-align: center;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>

{# Include shared scripts for oTree #}
{% include "_templates/scripts.html" %}

{# Main stylesheet for flower task #}
<link rel="stylesheet" href="{% static 'css/flowers.css' %}?v=11">
<title>Flower Field Task</title>

<div id="main-container">
    {# Top row: phase and round info #}
    <div class="row m-0 p-0" id="toprow" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
        <div class="col-12 p-1 border mt-1" style="width: 100%; max-width: 700px; text-align: center;">
            <h4 style="margin-bottom:0.5em;">{{ phase }}</h4>
            <h5>Round {{ phase_round }} / {{ phase_total }}</h5>
            <div id="top-earnings" style="font-size:1.1em; margin-top:0.5em;">
                Total earnings: £<span id="totalEarningsResult">{{ cumulative_earnings }}</span>
            </div>
        </div>
    </div>

    {# Instructions row: changes text depending on phase #}
    <div class="row m-0 p-0" id="instructions-row">
        <div class="col-12 p-2 text-center" style="font-size: 0.9rem; color: #333;">
            {% if phase == 'Test 1' or phase == 'Test 2' %}
                <span style="color: #a80000; font-weight: bold;">Select the configuration that fits best with your understanding of what causes flowers to grow.<br>
                This set will be transmitted to following participants.</span> <br><br>
                Click the <b>“Transmit"</b> button when you are ready.
            {% else %}
                Drag <b> one or two nutrients </b> under each flower to select your configuration.<br>
                Click the <b> “Submit" </b> button when you are ready to grow the flowers.
            {% endif %}
        </div>
    </div>

    {# Main game and results area #}
    <div class="row m-0 p-0" style="width: 100%;">
        <div class="col-12" id="currentRound" style="width: 100%; display: flex; justify-content: center; align-items: flex-start;">
            <!-- Flower Field Game -->
            <div class="flower-game-container" style="width: 100%;">
                <div id="flower-field-panel" class="white-panel">
                    {# Panel border changes color in Test 1 phase #}
                    {% if phase == 'Test 1' or phase == 'Test 2' %}
                    <style>
                        #flower-field-panel {
                            border: 3px solid #a80000;
                            border-radius: 10px;
                        }
                    </style>
                    {% endif %}
                    <div class="game-main">
                        <div id="status-message"></div>
                        <div id="flower-field-wrapper" class="{{ phase_class }}">
                            <!-- JS will fill flower-field with correct layout -->
                            <div id="flower-field" class="flower-slots-row" style="display: flex; justify-content: center; align-items: flex-end; width: 100%;"></div>
                        </div>
                        <div class="game-controls">
                            <button class="reset-button" id="resetButton">Reset</button>
                            <button class="submit-button" id="submitButton">{% if phase == 'Test 1' or phase == 'Test 2' %}Transmit{% else %}Submit{% endif %}</button>
                        </div>
                    </div>
                </div>
                <div class="side-panel-stack">
                    <div id="nutrient-panel"></div>
                    <!-- Results section removed -->
                </div>
            </div>
            <!-- Removed duplicate results section -->
        </div>
    </div>
</div>
{% if phase == 'Training phase' or phase == 'Exploration phase' %}
<div id="previous-combinations" style="width:100%; padding:8px 0 8px 0; text-align:center; margin:24px auto 0 auto; max-height:120px; overflow-y:auto;">
    {% if previous_combinations|length > 0 %}
    <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
        {% for combo in previous_combinations %}
                <div class="prev-combo{% if combo.zipped|length == 2 %} two-flowers{% endif %}" style="border:1px solid #ccc; border-radius:8px; padding:6px 10px 10px 10px; background:#fafafa; min-width:160px; max-width:220px; font-size:0.85em; display:flex; flex-direction:column; align-items:center;">
            <div style="font-weight:bold; margin-bottom:2px; font-size:0.95em;">Round {{ combo.round }}</div>
            <div style="display:flex; justify-content:center; align-items:flex-end; width:100%; gap:40px;">
                {% for flower, nutrient, score, flower_img, growth, flower_size in combo.zipped %}
                <div style="display:flex; flex-direction:column; align-items:center; margin:0 1px;">
                    {% if flower_img %}
                        {% if flower_size %}
                            <img src="{% static flower_img %}" width="{{ flower_size }}" height="{{ flower_size }}" style="margin-bottom:2px;" alt="{{ flower }}">
                        {% else %}
                            <img src="{% static flower_img %}" width="32" height="32" style="margin-bottom:2px;" alt="{{ flower }}">
                        {% endif %}
                    {% endif %}
                    <div style="display:flex; gap:1px; margin-bottom:1px; margin-top:2px;">
                        {% for nutrient_img in nutrient %}
                        {% if nutrient_img %}<img src="{% static nutrient_img %}" style="width:16px; height:16px;" alt="nutrient">{% endif %}
                        {% endfor %}
                    </div>
                    <span style="font-size:0.85em; color:#444; font-weight:bold; margin-top:0px;">{{ score }}p</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
    <style>
    .prev-combo.two-flowers .prev-combo-flowers-row,
    .prev-combo.two-flowers .prev-combo-scores-row {
        display: flex !important;
        justify-content: center !important;
        gap: 48px !important;
    }
    .prev-combo-flowers-row,
    .prev-combo-scores-row {
        display: flex;
        justify-content: space-between;
        width: 100%;
        gap: 0;
        margin-top: 2px;
    }
    </style>
{% endif %}

    <style>
        /* Center the card and its contents for Exploration phase */
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #flower-field-wrapper.training-phase-flowers {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.training-phase-flowers #flower-field {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.training-phase-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }

        #flower-field-wrapper.test-1-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.test-1-flowers #flower-field {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        #flower-field-wrapper.test-1-flowers .flower-container {
            width: 30%;
            margin: 10px 2%;
        }
        #flower-field-wrapper.test-1-flowers #flower-field .flower-container:nth-child(n+4) {
            margin-top: 40px;
        }
        #flower-field-wrapper.exploration-flowers {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #flower-field-wrapper.exploration-flowers #flower-field {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 80px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 420px;
        }
        #flower-field-wrapper.exploration-flowers .flower-container {
            min-width: 120px;
            margin: 0;
        }
    </style>
    </style>
    <script>
        window.js_vars = window.js_vars || {};
                    window.js_vars.treatment = "{{ session.config.display_name }}";
        window.js_vars.current_round = "{{ player.round_number }}";
        window.js_vars.phase = "{{ phase }}";
        window.js_vars.flower_colors = JSON.parse('{{ flower_colors|safe }}');

        console.log('Flowers template loaded, initializing...');
        // Initialize the game
        function initGame() {
            console.log('Attempting to initialize FlowerGame');
            console.log('window.FlowerGame exists:', typeof window.FlowerGame);
            if (window.flowerGame) {
                console.log('FlowerGame already created');
                return;
            }
            if (typeof FlowerGame !== 'undefined') {
                console.log('Creating new FlowerGame instance');
                window.flowerGame = new FlowerGame();
                // Pass flower colors for this round to the game instance
                if (window.js_vars.flower_colors) {
                    window.flowerGame.roundFlowerTypes = [window.js_vars.flower_colors];
                }
                console.log('FlowerGame created successfully');
                // Now initialize the game (populate the DOM)
                console.log('Initializing game UI...');
                window.flowerGame.init();
                console.log('Game UI initialized');
            } else {
                console.error('FlowerGame class not found!');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
        // Unified popup and overlay for Test 1 and Test 2 phases
        if (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2') {
            const overlay = document.createElement('div');
            overlay.id = 'test1-blocking-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(255,255,255,0.7)';
            overlay.style.zIndex = '9998';
            const style = document.createElement('style');
            style.innerHTML = '.bootbox.modal { z-index: 10000 !important; } .modal-backdrop { z-index: 9999 !important; }';
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            if (typeof bootbox !== 'undefined') {
                bootbox.dialog({
                    message: `<div style='font-size:1.15em; text-align:center;'>
                        <img src='${window.static ? window.static('img/Chain.png') : '/static/img/Chain.png'}' style='height:60px; margin-bottom:1em;'>
                        <div style='margin-bottom:1em;'>Please note that in the next round, the configuration you will choose will be seen by the next participant(s) in the chain.</div>
                    </div>`,
                    buttons: [
                        {
                            label: 'I understand',
                            className: 'btn-primary',
                            callback: function() {
                                // Remove overlay by ID
                                var overlays = document.querySelectorAll('#test1-blocking-overlay');
                                overlays.forEach(function(overlayElem) {
                                    if (overlayElem && overlayElem.parentNode) {
                                        overlayElem.parentNode.removeChild(overlayElem);
                                    }
                                });
                                // Remove any overlays with a likely overlay class
                                var overlayClassElems = document.querySelectorAll('.blocking-overlay, .otree-blocking-overlay');
                                overlayClassElems.forEach(function(elem) {
                                    if (elem && elem.parentNode) {
                                        elem.parentNode.removeChild(elem);
                                    }
                                });
                                // Restore scrolling
                                document.body.style.overflow = '';
                                document.documentElement.style.overflow = '';
                                // Forcefully remove Bootbox modal from DOM
                                var modals = document.querySelectorAll('.bootbox');
                                modals.forEach(function(modal) {
                                    if (modal && modal.parentNode) {
                                        modal.parentNode.removeChild(modal);
                                    }
                                });
                                // Also remove any modal-backdrop
                                var backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(function(backdrop) {
                                    if (backdrop && backdrop.parentNode) {
                                        backdrop.parentNode.removeChild(backdrop);
                                    }
                                });
                                return true;
                            }
                        }
                    ],
                    closeButton: false
                });
            } else {
                alert('Please note that in the next round, the configuration you will choose will be seen by the next participant(s) in the chain.');
                if (overlay && overlay.parentNode === document.body) {
                    document.body.removeChild(overlay);
                }
            }
        }
        initGame();
        // Fix: Reset button should only reset the field, not advance round
        const resetButton = document.getElementById('resetButton');
        if (resetButton) {
            resetButton.addEventListener('click', function(event) {
                event.preventDefault();
                window.flowerGame.resetFlowerField();
                document.getElementById('status-message').innerHTML = '';
            });
        }
        // Fix: Submit button should not advance round if not all flowers have at least one nutrient
        const submitButton = document.getElementById('submitButton');
        if (submitButton) {
            submitButton.addEventListener('click', function(event) {
                event.preventDefault();
                if (!window.flowerGame.isComplete()) {
                    document.getElementById('status-message').innerHTML = '<div class="status-message warning">Please feed all flowers with at least 1 nutrient each!</div>';
                    setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                    return;
                }
                const resetButton = document.getElementById('resetButton');
                if (window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2') {
                    // Show confirmation popup only for Test 1 and Test 2
                    let popupMessage = "Are you sure you’ve put the desired nutrients and want to transmit your configuration to following participants ?";
                    let yesLabel = 'Yes transmit';
                    if (typeof bootbox !== 'undefined') {
                        bootbox.dialog({
                            message: `<div style='font-size:1.1em; text-align:center;'>${popupMessage}</div>`,
                            buttons: [
                                {
                                    label: yesLabel,
                                    className: 'btn-primary',
                                    callback: function() {
                                        submitButton.disabled = true;
                                        document.getElementById('status-message').innerHTML = '';
                                        const flowerChoices = window.flowerGame.getFlowerChoices();
                                        liveSend({
                                            type: 'flowerSubmit',
                                            data: flowerChoices
                                        });
                                        return true;
                                    }
                                },
                                {
                                    label: 'No, continue editing',
                                    className: 'btn-secondary',
                                    callback: function() {
                                        if (resetButton) {
                                            resetButton.style.display = '';
                                        }
                                        return true;
                                    }
                                }
                            ]
                        });
                    }
                } else {
                    // Direct submit for all other phases
                    if (resetButton) {
                        resetButton.style.display = 'none';
                    }
                    submitButton.disabled = true;
                    document.getElementById('status-message').innerHTML = '';
                    const flowerChoices = window.flowerGame.getFlowerChoices();
                    liveSend({
                        type: 'flowerSubmit',
                        data: flowerChoices
                    });
                }
            });
        }
        // Listen for liveRecv to handle server response
        window.liveRecv = function(data) {
            // Accept both direct and wrapped responses
            let responseData = null;
            if (data && data.cumulative_earnings !== undefined) {
                responseData = data;
            } else {
                for (let key in data) {
                    if (data[key] && data[key].cumulative_earnings !== undefined) {
                        responseData = data[key];
                        break;
                    }
                }
            }
            if (responseData && responseData.cumulative_earnings !== undefined) {
                if (typeof disableNutrientPanelAndSlots === 'function') {
                    disableNutrientPanelAndSlots();
                }
                // Animate flower sizes and show results
                const isTestPhase = window.js_vars.phase === 'Test 1' || window.js_vars.phase === 'Test 2';
                if (!isTestPhase) {
                    if (window.flowerGame && typeof window.flowerGame.animateFlowerSizes === 'function') {
                        window.flowerGame.animateFlowerSizes(responseData.flower_scores);
                    }
                    if (window.flowerGame && typeof window.flowerGame.showAllScores === 'function') {
                        let scaledScores;
                        if (window.js_vars && window.js_vars.treatment && window.js_vars.treatment.toLowerCase().includes('m&m')) {
                            // For M&M config, min growth is 0.3, scale 0.3->100, 1.0->400
                            const minGrowth = 0.3, minPx = 100, maxPx = 400;
                            scaledScores = responseData.flower_scores.map(x => {
                                if (x <= minGrowth) return minPx;
                                return Math.round(minPx + (x - minGrowth) * (maxPx - minPx) / (1.0 - minGrowth));
                            });
                        } else {
                            // Default scaling
                            scaledScores = responseData.flower_scores.map(x => Math.round(x * 400));
                        }
                        window.flowerGame.showAllScores(scaledScores, responseData.flower_earnings);
                    }
                } else {
                    if (window.flowerGame && typeof window.flowerGame.hideAllScores === 'function') {
                        window.flowerGame.hideAllScores();
                    }
                }
                // Update total earnings display immediately after feedback
                if (responseData.cumulative_earnings !== undefined) {
                    const totalEarningsElem = document.getElementById('totalEarningsResult');
                    if (totalEarningsElem) {
                        totalEarningsElem.textContent = responseData.cumulative_earnings;
                    }
                }
                setTimeout(() => {
                    // Hide nutrient panel and center everything after feedback
                    submitButton.style.display = 'none';
                    resetButton.style.display = 'none';
                    document.getElementById('status-message').innerHTML = '';
                    const nutrientPanel = document.getElementById('nutrient-panel');
                    if (nutrientPanel) {
                        nutrientPanel.style.display = 'none';
                    }
                    const currentRound = document.getElementById('currentRound');
                    if (currentRound) {
                        currentRound.style.justifyContent = 'center';
                        currentRound.style.alignItems = 'flex-start';
                        // Force the main game container to be centered horizontally
                        const gameContainer = currentRound.querySelector('.flower-game-container');
                        if (gameContainer) {
                            gameContainer.style.marginLeft = 'auto';
                            gameContainer.style.marginRight = 'auto';
                            gameContainer.style.display = 'block';
                        }
                    }
                    // Add Continue button below the flower field if not present
                    let continueBtn = document.getElementById('continueAfterResults');
                    if (!continueBtn) {
                        continueBtn = document.createElement('button');
                        continueBtn.id = 'continueAfterResults';
                        continueBtn.className = 'btn btn-primary mt-3';
                        continueBtn.style.display = 'block';
                        continueBtn.style.margin = '32px auto 0 auto';
                        continueBtn.style.padding = '10px 20px';
                        continueBtn.style.fontSize = '1em';
                        continueBtn.style.minWidth = '220px';
                        continueBtn.style.maxWidth = '90vw';
                        continueBtn.style.whiteSpace = 'normal';
                        continueBtn.style.lineHeight = '1.25';
                        // Set button label based on phase
                        let phase = window.js_vars && window.js_vars.phase;
                        if (phase === 'Test 1') {
                            continueBtn.textContent = 'Continue to the Next Phase';
                        } else if (phase === 'Test 2') {
                            continueBtn.textContent = 'End task';
                        } else {
                            continueBtn.textContent = 'Continue to Next Round';
                        }
                        continueBtn.onclick = function() {
                            // Submit the hidden form to advance round
                            let form = document.getElementById('nextRoundForm');
                            if (!form) {
                                form = document.createElement('form');
                                form.id = 'nextRoundForm';
                                form.method = 'post';
                                form.style.display = 'none';
                                document.body.appendChild(form);
                            }
                            form.submit();
                        };
                        // Center the button below the flower field
                        const flowerPanel = document.getElementById('flower-field-panel');
                        if (flowerPanel) {
                            const panelCol = document.createElement('div');
                            panelCol.style.textAlign = 'center';
                            panelCol.appendChild(continueBtn);
                            flowerPanel.appendChild(panelCol);
                        } else {
                            document.body.appendChild(continueBtn);
                        }
                    }
                }, 700);
            }
        };
        // Format total earnings on page load
        var totalEarningsElem = document.getElementById('totalEarningsResult');
        if (totalEarningsElem) {
            var val = parseFloat(totalEarningsElem.textContent);
            if (!isNaN(val)) {
                totalEarningsElem.textContent = val.toFixed(2);
            }
        }
        // (Removed duplicate Test 1 popup logic; now unified above)

    });

</script>
<script src="{% static 'flowers.js' %}?v=7"></script>
{% endblock %}
